<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GLB World Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>

<style>
html,body { margin:0; padding:0; overflow:hidden; background:#000; font-family:sans-serif }
#ui {
  position:fixed; top:10px; left:10px; z-index:10;
  background:rgba(0,0,0,.6); padding:10px; border-radius:8px; color:#fff
}
button { margin:4px 0; width:100% }
select { width:100% }
.joystick {
  position:fixed; bottom:20px; width:120px; height:120px;
  border-radius:50%; background:rgba(255,255,255,.1);
}
#leftJoy { left:20px }
#rightJoy { right:20px }
.knob {
  position:absolute; left:40px; top:40px;
  width:40px; height:40px; border-radius:50%;
  background:rgba(255,255,255,.4)
}
</style>
</head>
<body>

<div id="ui">
  <input type="file" id="fileInput" multiple accept=".glb"/>
  <button onclick="saveWorld()">ðŸ’¾ Save World</button>
  <select id="worlds" onchange="loadWorld()"></select>
</div>

<div id="leftJoy" class="joystick"><div class="knob"></div></div>
<div id="rightJoy" class="joystick"><div class="knob"></div></div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/loaders/GLTFLoader.js';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/controls/OrbitControls.js';

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

let camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 10000);
camera.position.set(0,2,6);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

let controls = new OrbitControls(camera, renderer.domElement);
controls.enablePan = false;
controls.enableZoom = false;

let light = new THREE.HemisphereLight(0xffffff,0x444444,1.2);
scene.add(light);

let ground = new THREE.Mesh(
  new THREE.PlaneGeometry(500,500),
  new THREE.MeshStandardMaterial({color:0x333333})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

let loader = new GLTFLoader();
let objects = [];
let avatar = null;

function normalize(model){
  let box = new THREE.Box3().setFromObject(model);
  let size = box.getSize(new THREE.Vector3()).length();
  let scale = 2 / size;
  model.scale.setScalar(scale);
}

document.getElementById('fileInput').addEventListener('change', e=>{
  [...e.target.files].forEach((file,i)=>{
    let url = URL.createObjectURL(file);
    loader.load(url, gltf=>{
      let m = gltf.scene;
      normalize(m);
      m.position.set(i*4,0,0);
      m.userData.file = file.name;
      scene.add(m);
      objects.push(m);
      if(!avatar) avatar = m;
    });
  });
});

function saveWorld(){
  let name = prompt("World name?");
  if(!name) return;
  let data = objects.map(o=>({
    file:o.userData.file,
    pos:o.position.toArray(),
    rot:o.rotation.toArray(),
    scale:o.scale.toArray()
  }));
  localStorage.setItem("world_"+name, JSON.stringify(data));
  refreshWorlds();
}

function loadWorld(){
  let name = worlds.value;
  if(!name) return;
  objects.forEach(o=>scene.remove(o));
  objects.length = 0;

  let data = JSON.parse(localStorage.getItem("world_"+name));
  data.forEach((d,i)=>{
    loader.load(URL.createObjectURL(
      [...fileInput.files].find(f=>f.name===d.file)
    ), gltf=>{
      let m = gltf.scene;
      m.position.fromArray(d.pos);
      m.rotation.fromArray(d.rot);
      m.scale.fromArray(d.scale);
      m.userData.file = d.file;
      scene.add(m);
      objects.push(m);
      if(!avatar) avatar = m;
    });
  });
}

function refreshWorlds(){
  worlds.innerHTML = '<option value="">Load World</option>';
  Object.keys(localStorage).filter(k=>k.startsWith("world_")).forEach(k=>{
    let o=document.createElement('option');
    o.value=k.replace("world_","");
    o.textContent=o.value;
    worlds.appendChild(o);
  });
}
refreshWorlds();

/* ---- JOYSTICKS ---- */
function joystick(el, cb){
  let knob = el.firstChild;
  let active=false;
  el.addEventListener('pointerdown',e=>active=true);
  window.addEventListener('pointerup',e=>{
    active=false;
    knob.style.transform='';
    cb(0,0);
  });
  window.addEventListener('pointermove',e=>{
    if(!active) return;
    let r=60;
    let x=Math.max(-r,Math.min(r,e.movementX));
    let y=Math.max(-r,Math.min(r,e.movementY));
    knob.style.transform=`translate(${x}px,${y}px)`;
    cb(x/r,y/r);
  });
}

let move={x:0,z:0,y:0};
joystick(leftJoy,(x,y)=>{ move.x=x; move.z=y; });
joystick(rightJoy,(x,y)=>{ move.y=-y; move.x+=x*0.5; });

function animate(){
  requestAnimationFrame(animate);
  if(avatar){
    avatar.position.x += move.x*0.1;
    avatar.position.z += move.z*0.1;
    avatar.position.y += move.y*0.1;
    camera.position.lerp(
      avatar.position.clone().add(new THREE.Vector3(0,2,6)),
      0.1
    );
    camera.lookAt(avatar.position);
  }
  renderer.render(scene,camera);
}
animate();

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>