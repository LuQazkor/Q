<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>GLB World</title>

<style>
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#000}
#c{width:100%;height:100%;display:block;touch-action:none}
#hud{
  position:fixed;top:10px;left:10px;z-index:50;
  font:13px system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  color:#fff;background:rgba(0,0,0,.65);
  padding:10px;border-radius:10px;max-width:calc(100vw - 20px)
}
#hud .small{opacity:.85;font-size:12px;margin-top:6px;white-space:pre-wrap}
#mobile{position:fixed;left:0;right:0;bottom:0;z-index:60;pointer-events:none}
.pad{pointer-events:auto;position:absolute;bottom:14px;width:150px;height:150px;
background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:999px}
#leftPad{left:14px}
#rightPad{right:14px;width:170px;height:170px}
.stick{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
width:64px;height:64px;border-radius:999px;background:rgba(255,255,255,.2)}
#btns{pointer-events:auto;position:absolute;left:50%;transform:translateX(-50%);
bottom:14px;display:flex;gap:8px;flex-wrap:wrap}
button{border:0;border-radius:999px;padding:10px 12px;
background:rgba(0,0,0,.65);color:#fff}
</style>
</head>

<body>
<div id="hud">
  <div><b>Controls</b> WASD · Mouse · Space/Shift · F fly/walk · E interact · R reset</div>
  <div class="small" id="msg">Booting…</div>
</div>

<div id="mobile" style="display:none">
  <div id="leftPad" class="pad"><div class="stick"></div></div>
  <div id="rightPad" class="pad"><div class="stick"></div></div>
  <div id="btns">
    <button id="bFly">Fly/Walk</button>
    <button id="bUp">Up</button>
    <button id="bDown">Down</button>
    <button id="bUse">Interact</button>
    <button id="bReset">Reset</button>
  </div>
</div>

<canvas id="c"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<script>
/* ---------- Engine & Scene ---------- */
const canvas = document.getElementById("c");
const engine = new BABYLON.Engine(canvas,true);
const scene  = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color4(0.02,0.02,0.02,1);
scene.collisionsEnabled = true;

const msg = t=>document.getElementById("msg").textContent=t;

/* ---------- Lighting (FORCED VISIBILITY) ---------- */
new BABYLON.HemisphericLight("hemi",new BABYLON.Vector3(0,1,0),scene).intensity=1.1;

const sun = new BABYLON.DirectionalLight("sun",new BABYLON.Vector3(-0.4,-1,-0.4),scene);
sun.position = new BABYLON.Vector3(100,200,100);
sun.intensity = 2.2;

/* Skybox so black void never happens */
scene.createDefaultEnvironment({ skyboxSize:5000 });

/* ---------- Camera ---------- */
let flyMode = true;
const cam = new BABYLON.UniversalCamera("cam",new BABYLON.Vector3(0,2,-10),scene);
cam.attachControl(canvas,true);
cam.minZ = 0.05;
cam.maxZ = 10000;
cam.speed = 0.4;
cam.applyGravity = false;
cam.checkCollisions = true;
cam.ellipsoid = new BABYLON.Vector3(0.4,0.9,0.4);

/* Ground safety */
const ground = BABYLON.MeshBuilder.CreateGround("g",{width:8000,height:8000},scene);
ground.isVisible=false;
ground.checkCollisions=true;

/* ---------- Controls ---------- */
const keys=new Set();
window.addEventListener("keydown",e=>{
  keys.add(e.code);
  if(e.code==="KeyF"){flyMode=!flyMode;cam.applyGravity=!flyMode}
  if(e.code==="KeyR"){cam.position.set(0,2,-10);cam.rotation.set(0,0,0)}
  if(e.code==="KeyE") interact();
});
window.addEventListener("keyup",e=>keys.delete(e.code));

function interact(){
  const p=scene.pick(engine.getRenderWidth()/2,engine.getRenderHeight()/2);
  if(p?.hit) msg("INTERACT: "+p.pickedMesh.name);
}

/* ---------- Movement ---------- */
scene.onBeforeRenderObservable.add(()=>{
  const dt=engine.getDeltaTime()/1000;
  let f=0,s=0,u=0;
  if(keys.has("KeyW"))f++;
  if(keys.has("KeyS"))f--;
  if(keys.has("KeyD"))s++;
  if(keys.has("KeyA"))s--;
  if(flyMode){
    if(keys.has("Space"))u++;
    if(keys.has("ShiftLeft"))u--;
  }
  const forward=cam.getDirection(BABYLON.Axis.Z);
  const right=cam.getDirection(BABYLON.Axis.X);
  cam.moveWithCollisions(
    forward.scale(f*dt*20)
      .add(right.scale(s*dt*20))
      .add(new BABYLON.Vector3(0,u*dt*20,0))
  );
});

/* ---------- GitHub API: load ALL /glb ---------- */
function getRepo(){
  const owner=location.hostname.split(".")[0];
  const p=location.pathname.split("/").filter(Boolean);
  return {owner,repo:p.length?p[0]:owner+".github.io"};
}

async function listGlbs(o,r){
  const res=await fetch(`https://api.github.com/repos/${o}/${r}/contents/glb`);
  if(!res.ok) throw "No /glb folder";
  return (await res.json()).filter(x=>x.name.endsWith(".glb"));
}

function forceVisible(mesh){
  if(mesh.material){
    mesh.material.backFaceCulling=false;
    mesh.material.disableLighting=false;
  }
}

/* ---------- Load Worlds ---------- */
async function loadAll(){
  const {owner,repo}=getRepo();
  msg("Listing /glb…");
  const glbs=await listGlbs(owner,repo);
  let i=0,spacing=120;
  for(const g of glbs){
    const root=new BABYLON.TransformNode("W_"+g.name,scene);
    const res=await BABYLON.SceneLoader.ImportMeshAsync("", "", g.download_url, scene);
    res.meshes.forEach(m=>{
      m.parent=root;
      m.checkCollisions=true;
      m.isPickable=true;
      forceVisible(m);
    });
    root.position.set(i*spacing,0,0);
    if(i===0){
      const b=root.getHierarchyBoundingVectors();
      cam.position=b.min.add(b.max).scale(0.5).add(new BABYLON.Vector3(0,5,-15));
      cam.setTarget(b.min.add(b.max).scale(0.5));
    }
    i++;
  }
  msg(`Ready. Loaded ${glbs.length}/${glbs.length}. Fly between scenes.`);
}

loadAll().catch(e=>msg(String(e)));
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
